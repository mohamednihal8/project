{% extends "base.html" %}
{% block content %}
<div class="section predict-section">
    <h1>Health Prediction</h1>
    <form method="POST" id="prediction-form" novalidate>
        <!-- Demographic Information -->
        <div class="form-section">
            <h2>Demographic Information</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label for="Age">Age</label>
                    <input type="number" id="Age" name="Age" class="tooltip-input" data-tooltip="Your age in years" min="0" max="120" step="1" value="45" required>
                </div>
                <div class="input-group">
                    <label for="Gender">Gender</label>
                    <select id="Gender" name="Gender" required>
                        <option value="" disabled>Select Gender</option>
                        <option value="0" selected>Male</option>
                        <option value="1">Female</option>
                        <option value="2">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="BMI">BMI</label>
                    <input type="number" id="BMI" name="BMI" class="tooltip-input" data-tooltip="Body Mass Index (kg/mÂ²)" min="10" max="50" step="0.1" value="27.5" required>
                </div>
            </div>
        </div>

        <!-- Blood Tests -->
        <div class="form-section">
            <h2>Blood Tests</h2>
            <div class="form-grid">
                {% set blood_test_values = {
                    'Hemoglobin': 14.2, 'WBC': 6.5, 'RBC': 4.8, 'Platelets': 250, 'Glucose_Fasting': 95,
                    'HbA1c': 5.5, 'Cholesterol_Total': 190, 'Triglycerides': 130, 'LDL': 110, 'HDL': 50,
                    'ALT': 25, 'AST': 20, 'Bilirubin_Total': 0.8, 'Creatinine': 0.9, 'Urea': 20,
                    'TSH': 2.5, 'T3': 1.2, 'T4': 8.0, 'CRP': 2.0
                } %}
                {% for field in ['Hemoglobin', 'WBC', 'RBC', 'Platelets', 'Glucose_Fasting', 'HbA1c', 'Cholesterol_Total', 'Triglycerides', 'LDL', 'HDL', 'ALT', 'AST', 'Bilirubin_Total', 'Creatinine', 'Urea', 'TSH', 'T3', 'T4', 'CRP'] %}
                <div class="input-group">
                    <label for="{{ field }}">{{ field.replace('_', ' ') }}</label>
                    <input type="number" id="{{ field }}" name="{{ field }}" class="tooltip-input" data-tooltip="{{ field }} level in blood" step="0.1" min="0" value="{{ blood_test_values[field] }}" required>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Lifestyle Factors -->
        <div class="form-section">
            <h2>Lifestyle Factors</h2>
            <div class="form-grid">
                <div class="input-group">
                    <label for="Smoker">Smoker</label>
                    <select id="Smoker" name="Smoker" required>
                        <option value="" disabled>Select</option>
                        <option value="0" selected>No</option>
                        <option value="1">Yes</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="Alcohol_Intake">Alcohol Intake</label>
                    <select id="Alcohol_Intake" name="Alcohol_Intake" required>
                        <option value="" disabled>Select</option>
                        <option value="0">None</option>
                        <option value="1" selected>Low</option>
                        <option value="2">Moderate</option>
                        <option value="3">High</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="Exercise_Freq">Exercise Frequency</label>
                    <select id="Exercise_Freq" name="Exercise_Freq" required>
                        <option value="" disabled>Select</option>
                        <option value="Never" selected>Never</option>
                        <option value="Rarely">Rarely</option>
                        <option value="Occasionally">Occasionally</option>
                        <option value="Regularly">Regularly</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Medical History -->
        <div class="form-section">
            <h2>Medical History</h2>
            <div class="form-grid">
                {% for field in ['COVID_Antigen_Pos', 'HIV_Positive', 'Hepatitis_B_Pos', 'Hepatitis_C_Pos', 'Malaria_Positive', 'Tuberculosis_Pos'] %}
                <div class="input-group">
                    <label for="{{ field }}">{{ field.replace('_', ' ') }}</label>
                    <select id="{{ field }}" name="{{ field }}" required>
                        <option value="" disabled>Select</option>
                        <option value="0" selected>No</option>
                        <option value="1">Yes</option>
                    </select>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn">Predict</button>
            <button type="submit" name="download_pdf" value="1" class="btn">Download PDF</button>
        </div>
    </form>

    <!-- Prediction Results -->
    {% if prediction %}
    <div class="result-section">
        <h2>Prediction Result</h2>
        <p><strong>Predicted Disease:</strong> {{ prediction }}</p>
        <p><strong>Confidence:</strong> {{ "%.2f" % confidence }}%</p>
        <h3>Other Possibilities</h3>
        <ul>
            {% for disease, prob in other_probs %}
            <li>{{ disease }}: {{ "%.2f" % (prob*100) }}%</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Tooltip functionality
    const inputs = document.querySelectorAll('.tooltip-input, select');
    inputs.forEach(input => {
        input.addEventListener('mouseenter', function() {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerText = input.dataset.tooltip || input.labels[0]?.innerText + ' information';
            document.body.appendChild(tooltip);
            const rect = input.getBoundingClientRect();
            tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
            tooltip.style.left = `${rect.left + window.scrollX}px`;
        });
        input.addEventListener('mouseleave', function() {
            document.querySelector('.tooltip')?.remove();
        });
    });

    // Form validation
    const form = document.getElementById('prediction-form');
    form.addEventListener('submit', function(e) {
        let valid = true;
        form.querySelectorAll('input[type="number"]').forEach(input => {
            if (input.value < input.min || (input.max && input.value > input.max)) {
                valid = false;
                input.classList.add('error');
            } else {
                input.classList.remove('error');
            }
        });
        if (!valid) {
            e.preventDefault();
            alert('Please ensure all numerical inputs are within valid ranges.');
        }
    });
});
</script>
{% endblock %}